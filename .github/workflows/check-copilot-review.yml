name: Check Copilot Review

on:
  pull_request:
    types: [opened, synchronize, reopened, review_requested]
  pull_request_review:
    types: [submitted, edited, dismissed]

jobs:
  check-copilot-review:
    name: Verify Copilot Review Exists
    runs-on: ubuntu-latest
    steps:
      - name: Check for Copilot review
        uses: actions/github-script@v7
        with:
          script: |
            // Get all commits in the PR
            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            // Get the latest commit date
            if (!commits || commits.length === 0) {
              core.info('â„¹ï¸ no commits found in the pull request. Skipping Copilot review freshness check.');
              return;
            } 

            // Find the latest content-changing commit that requires review
            let latestCommit = commits[commits.length - 1];
            for (let i = commits.length - 1; i >= 0; i--) {
              const c = commits[i];
              const message = c.commit.message; 
              
              // Skip commits that shouldn't invalidate a review
              const isMerge = message.startsWith('Merge branch') || message.startsWith('Merge pull request');
              const isRevert = message.startsWith('Revert "');
              const isSkip = message.includes('[skip review]');

              if (!isMerge && !isRevert && !isSkip) {
                latestCommit = c;
                break;
              }
            }

            const latestCommitDate = new Date(latestCommit.commit.committer.date);
            core.info(`â±ï¸ Latest content commit: ${latestCommit.sha.substring(0, 7)} at ${latestCommitDate.toISOString()}`);
            
            // Get all reviews
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number,
            });
            
            // Find Copilot review
            const copilotReview = reviews.find(review => 
              review.user.login === 'copilot-pull-request-reviewer[bot]' ||
              review.user.type === 'Bot'
            );
            
            if (!copilotReview) {
              core.setFailed('âŒ Copilot review is required but not found. Please wait for Copilot to review this PR.');
            } else {
              const reviewDate = new Date(copilotReview.submitted_at);
              core.info(`âœ… Copilot review found!`);
              core.info(`ğŸ“„ Review state: ${copilotReview.state}`);
              core.info(`ğŸ“… Review submitted at: ${reviewDate.toISOString()}`);
              
              // Check if review is older than the latest commit
              if (reviewDate < latestCommitDate) {
                core.setFailed(`âš ï¸ Copilot review (${reviewDate.toISOString()}) is older than the latest commit (${latestCommitDate.toISOString()}). A new review is required after code changes.`);
              } else {
                core.info('âœ… Copilot review is up-to-date with the latest commit!');
              }
            }
