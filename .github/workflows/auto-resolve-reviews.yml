name: Auto-Resolve Review Comments

on:
  pull_request:
    types: [opened, synchronize]
    paths-ignore:
      - '.github/pr-resolution-cache.json'

jobs:
  auto-resolve:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all commits for proper diff analysis

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install octokit

      - name: Restore/Save Cache
        uses: actions/cache@v4
        with:
          path: .github/pr-resolution-cache.json
          # Use run_id in the key to force a new cache entry save every run (if changed)
          key: pr-resolution-cache-${{ github.run_id }}
          # Restore from the latest available cache with this prefix
          restore-keys: |
            pr-resolution-cache-

      - name: Run auto-resolution
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_EVENT_PATH: ${{ github.event_path }}
        run: node scripts/auto-resolve-reviews.js

      - name: Trigger check-bot-review workflow
        uses: actions/github-script@v7
        with:
          script: |
            /**
             * Wait for a short period using exponential backoff before
             * triggering the check-bot-review workflow. This avoids relying
             * on a single hardcoded delay and is more resilient to backend
             * propagation variance.
             */
            async function waitForReviewPropagation(maxAttempts = 3, initialDelayMs = 1000) {
              let delay = initialDelayMs;
              for (let attempt = 1; attempt <= maxAttempts; attempt++) {
                core.info(`⏱ Waiting ${delay} ms before triggering check-bot-review (attempt ${attempt}/${maxAttempts})`);
                await new Promise(resolve => setTimeout(resolve, delay));
                delay *= 2;
              }
            }

            // Wait a moment to help ensure review thread updates are propagated
            await waitForReviewPropagation();
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = context.payload.pull_request.number;

            // Get the PR's head branch to trigger the workflow on the correct ref
            const { data: pr } = await github.rest.pulls.get({
              owner,
              repo,
              pull_number
            });

            const headBranch = pr.head.ref;

            try {
              // Trigger the check-bot-review workflow via workflow_dispatch
              await github.rest.actions.createWorkflowDispatch({
                owner,
                repo,
                workflow_id: 'check-bot-review.yml',
                ref: headBranch,
                inputs: {
                  pull_request_number: String(pull_number)
                }
              });

              core.info(`✅ Successfully triggered check-bot-review workflow for PR #${pull_number} on branch ${headBranch}`);
            } catch (error) {
              core.warning(`⚠️ Could not trigger check-bot-review workflow: ${error.message}`);
              core.info('The check-bot-review workflow will run on the next PR event');
            }
