name: Update PR Description

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, closed]
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR number to update"
        required: true
        type: number

permissions:
  pull-requests: write
  contents: read

jobs:
  update-pr-description:
    runs-on: ubuntu-latest
    if: (github.event.pull_request.draft == false || github.event_name == 'workflow_dispatch') || (github.event.action == 'closed' && github.event.pull_request.merged == true)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref || github.event.pull_request.base.ref || github.ref }}

      - name: Get PR information and parse markers
        uses: actions/github-script@v7
        with:
          script: |
            const dedent = (str) =>
              str
                .replace(/^\n/, '')
                .replace(/\n\s+/g, '\n')
                .trim() + '\n';

            const prNumber =
              context.payload.pull_request?.number ??
              (context.payload.inputs?.pr_number ? Number(context.payload.inputs.pr_number) : undefined);

            if (!prNumber) {
              core.setFailed('PR number not found.');
              return;
            }

            const isMerged =
              context.eventName === 'pull_request' &&
              context.payload.action === 'closed' &&
              context.payload.pull_request?.merged === true;

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            const { data: commits } = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            // ===== Preserve user content =====
            const body = pr.body || '';
            const userMatch = body.match(/<!-- USER_CONTENT_START -->([\s\S]*?)<!-- USER_CONTENT_END -->/);

            const userContent = userMatch
              ? userMatch[1].trim()
              : body.split('<!-- AUTO_GENERATED_START -->')[0].trim();

            // ===== Stats =====
            const stats = {
              filesChanged: files.length,
              additions: files.reduce((s, f) => s + (f.additions || 0), 0),
              deletions: files.reduce((s, f) => s + (f.deletions || 0), 0),
              commits: commits.length
            };

            // ===== File tree =====
            const fileMap = {};
            files.forEach(f => fileMap[f.filename] = f);

            function buildTree(paths) {
              const root = {};
              for (const p of paths) {
                let cur = root;
                const parts = p.split('/');
                parts.forEach((part, i) => {
                  cur[part] ??= {};
                  if (i === parts.length - 1) cur[part]._file = true;
                  cur = cur[part];
                });
              }
              return root;
            }

            function renderTree(node, prefix = '') {
              let out = '';
              const entries = Object.keys(node).filter(k => k !== '_file').sort();
              entries.forEach((k, i) => {
                const last = i === entries.length - 1;
                const conn = last ? 'â””â”€â”€ ' : 'â”œâ”€â”€ ';
                const next = last ? '    ' : 'â”‚   ';
                if (node[k]._file) {
                  const f = fileMap[k] || {};
                  out += `${prefix}${conn}${k} (+${f.additions || 0}/-${f.deletions || 0})\n`;
                } else {
                  out += `${prefix}${conn}${k}/\n`;
                  out += renderTree(node[k], prefix + next);
                }
              });
              return out;
            }

            const tree = renderTree(buildTree(Object.keys(fileMap)));

            // ===== Commits =====
            const commitsList = commits
              .map(c => `- \`${c.sha.slice(0, 7)}\` â€“ ${c.commit.message.split('\n')[0]}`)
              .join('\n');

            // ===== Architecture =====
            let architectureSection = '';
            if (isMerged) {
              architectureSection = dedent(`
                ## ğŸ—ï¸ Architecture (Auto-generated)

                \`\`\`mermaid
                graph TD
                  UI --> API
                  API --> DB
                \`\`\`
              `);
            }

            const autoGenerated = dedent(`
              <!-- AUTO_GENERATED_START -->

              ## ğŸ“ Changed files

              \`\`\`
              ${tree.trim()}
              \`\`\`

              ## ğŸ“Š Stats

              | Metric | Value |
              |--------|------:|
              | Files changed | ${stats.filesChanged} |
              | Lines added | +${stats.additions} |
              | Lines deleted | -${stats.deletions} |
              | Commits | ${stats.commits} |

              ## ğŸ“ Commits

              ${commitsList}
              ${architectureSection}

              <!-- AUTO_GENERATED_END -->
            `);

            const finalBody = dedent(`
              <!-- USER_CONTENT_START -->
              ${userContent}
              <!-- USER_CONTENT_END -->

              ${autoGenerated}
            `);

            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              body: finalBody
            });

            core.info(isMerged ? 'âœ… PR merged â€“ description finalized' : 'ğŸ”„ PR description updated');

      - name: Comment on PR (only on first run)
        if: github.event.action == 'opened'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: 'ğŸ¤– The PR description was updated with detailed stats. It refreshes on each push, and an architecture diagram is generated on merge.'
            });
