#!/usr/bin/env node

/**
 * Custom emoji-based commit message validation
 * Enforces conventional commits with emojis
 */

const fs = require('fs');

const COMMIT_MSG_FILE = process.argv[2];
const commitMessage = fs.readFileSync(COMMIT_MSG_FILE, 'utf-8').trim();

// Valid emoji prefixes
const VALID_EMOJIS = {
  'âœ¨': 'New feature',
  'ğŸ›': 'Bug fix',
  'ğŸ“š': 'Documentation',
  'â™»ï¸': 'Refactoring',
  'âš¡': 'Performance improvement',
  'âœ…': 'Tests',
  'ğŸ”§': 'Configuration',
  'ğŸ”’': 'Security',
  'â¬†ï¸': 'Dependencies upgrade',
  'â¬‡ï¸': 'Dependencies downgrade',
  'ğŸ¨': 'Style/formatting',
  'ğŸš€': 'Deployment',
  'ğŸ”¥': 'Remove code/files',
  'ğŸ’¥': 'Breaking changes',
  'ğŸš‘': 'Critical hotfix',
  'ğŸ”€': 'Merge',
  'âª': 'Revert',
  'ğŸ—ï¸': 'Architecture',
  'ğŸ“¦': 'Package/build',
  'ğŸ‘·': 'CI/CD',
};

// Pattern: emoji + space + message (min 10 chars)
const COMMIT_PATTERN = new RegExp(
  `^(${Object.keys(VALID_EMOJIS).join('|')}) .{10,}$`
);

// Allow merge commits, revert commits, and automated commits
const SPECIAL_PATTERNS = [
  /^Merge /,
  /^Revert /,
  /^Initial commit$/,
  /^Bump version/,
];

function validateCommit(message) {
  // Get only the first line (subject) for validation
  const firstLine = message.split('\n')[0].trim();

  // Check special patterns
  for (const pattern of SPECIAL_PATTERNS) {
    if (pattern.test(firstLine)) {
      return { valid: true };
    }
  }

  // Check emoji pattern
  if (!COMMIT_PATTERN.test(firstLine)) {
    const validEmojis = Object.entries(VALID_EMOJIS)
      .map(([emoji, desc]) => `  ${emoji}  ${desc}`)
      .join('\n');

    return {
      valid: false,
      error: `
âŒ Invalid commit message format!

Your commit message:
"${firstLine}"

Expected format: <emoji> <message>

Valid emojis:
${validEmojis}

Examples:
  âœ¨ Add new feature for auto-tapping
  ğŸ› Fix issue with storage API
  ğŸ“š Update README with new instructions
  â™»ï¸ Refactor message handler

Message must be at least 10 characters after the emoji.
`,
    };
  }

  return { valid: true };
}

const result = validateCommit(commitMessage);

if (!result.valid) {
  console.error(result.error);
  process.exit(1);
}

console.log('âœ… Commit message validated successfully!');
process.exit(0);
